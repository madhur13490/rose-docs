<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ROSE: GenericString.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li><a href="examples.html"><span>Examples</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>GenericString.C</h1><a href="GenericString_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Strings. Uniform treatment for strings stored in a binary file and strings generated on the fly. */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include "<a class="code" href="sage3basic_8h.html">sage3basic.h</a>"</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 std::string
<a name="l00006"></a><a class="code" href="classSgAsmGenericString.html#ba8bc51c8d891e4f8e8e87c45c62f7d5">00006</a> <a class="code" href="classSgAsmGenericString.html#ba8bc51c8d891e4f8e8e87c45c62f7d5">SgAsmGenericString::get_string</a>(<span class="keywordtype">bool</span> <a class="code" href="namespaceDbg.html#30e026df9550320a5ed77068dc06d501">escape</a>)<span class="keyword"> const</span>
<a name="l00007"></a>00007 <span class="keyword"></span>{
<a name="l00008"></a>00008     ROSE_ASSERT(!<span class="stringliteral">"should have been pure virtual if ROSETTA supported that."</span>);
<a name="l00009"></a>00009     abort();
<a name="l00010"></a>00010 
<a name="l00011"></a>00011     <span class="comment">// DQ (11/27/2009): MSVC requires a return stmt for any non-void return type of a function.</span>
<a name="l00012"></a>00012     <span class="keywordflow">return</span> <span class="stringliteral">"error in SgAsmGenericString::get_string()"</span>;
<a name="l00013"></a>00013 }
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="keywordtype">void</span>
<a name="l00016"></a><a class="code" href="classSgAsmGenericString.html#041608b8297d9f4bd334806d8f277e1b">00016</a> <a class="code" href="classSgAsmGenericString.html#041608b8297d9f4bd334806d8f277e1b">SgAsmGenericString::set_string</a>(<span class="keyword">const</span> std::string &amp;s)
<a name="l00017"></a>00017 {
<a name="l00018"></a>00018     ROSE_ASSERT(!<span class="stringliteral">"should have been pure virtual if ROSETTA supported that."</span>);
<a name="l00019"></a>00019     abort();
<a name="l00020"></a>00020 }
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keywordtype">void</span>
<a name="l00023"></a><a class="code" href="classSgAsmGenericString.html#658caa5452a14ba2d47a39ca07545db2">00023</a> <a class="code" href="classSgAsmGenericString.html#041608b8297d9f4bd334806d8f277e1b">SgAsmGenericString::set_string</a>(<a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> offset)
<a name="l00024"></a>00024 {
<a name="l00025"></a>00025     ROSE_ASSERT(!<span class="stringliteral">"should have been pure virtual if ROSETTA supported that."</span>);
<a name="l00026"></a>00026     abort();
<a name="l00027"></a>00027 }
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="keywordtype">void</span>
<a name="l00030"></a><a class="code" href="classSgAsmGenericString.html#e0cddcfb47409796269c2a1252fa0fae">00030</a> <a class="code" href="classSgAsmGenericString.html#e0cddcfb47409796269c2a1252fa0fae">SgAsmGenericString::dump</a>(FILE*, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="SgUnaryOp_8docs.html#c6cf1576467b95ef29f025f8e47eea437afa939f8bd773f5f7e326990b07580c">prefix</a>, ssize_t idx)<span class="keyword"> const</span>
<a name="l00031"></a>00031 <span class="keyword"></span>{
<a name="l00032"></a>00032     ROSE_ASSERT(!<span class="stringliteral">"should have been pure virtual if ROSETTA supported that."</span>);
<a name="l00033"></a>00033     abort();
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/* Constructor */</span>
<a name="l00037"></a>00037 <span class="keywordtype">void</span>
<a name="l00038"></a><a class="code" href="classSgAsmBasicString.html#7491758ce1ff5f4292dc5ce56b780e8b">00038</a> <a class="code" href="classSgAsmBasicString.html#7491758ce1ff5f4292dc5ce56b780e8b">SgAsmBasicString::ctor</a>()
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040 <span class="preprocessor">#if 0</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">"SgAsmBasicString::ctor this=0x%08lx\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<span class="keyword">this</span>);
<a name="l00042"></a>00042     <span class="keywordflow">if</span> (<span class="keyword">this</span>==(<span class="keywordtype">void</span>*)0x685998)
<a name="l00043"></a>00043         abort(); <span class="comment">/*DEBUGGING (rpm 2008-10-10)*/</span>
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>}
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">/* Override ROSETTA because generated code doesn't match virtual signature in base class */</span>
<a name="l00048"></a>00048 std::string
<a name="l00049"></a><a class="code" href="classSgAsmBasicString.html#176b4a26f1315f64c7de4b920b88646d">00049</a> <a class="code" href="classSgAsmBasicString.html#176b4a26f1315f64c7de4b920b88646d">SgAsmBasicString::get_string</a>(<span class="keywordtype">bool</span> <a class="code" href="namespaceDbg.html#30e026df9550320a5ed77068dc06d501">escape</a>)<span class="keyword"> const</span>
<a name="l00050"></a>00050 <span class="keyword"></span>{
<a name="l00051"></a>00051     <span class="keywordflow">if</span> (escape)
<a name="l00052"></a>00052         <span class="keywordflow">return</span> <a class="code" href="escape_8h.html#fe2eed2102b5e1df8cf454304111f5ca">escapeString</a>(<a class="code" href="classSgAsmBasicString.html#78caa100d3ca1da1ca90edeb3e30bbc0">p_string</a>);
<a name="l00053"></a>00053     <span class="keywordflow">return</span> p_string;
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 <span class="keywordtype">void</span>
<a name="l00056"></a><a class="code" href="classSgAsmBasicString.html#6e8c6524a3bae9487e2d19c2155f992a">00056</a> <a class="code" href="classSgAsmBasicString.html#6e8c6524a3bae9487e2d19c2155f992a">SgAsmBasicString::set_string</a>(<span class="keyword">const</span> std::string &amp;s)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058     <span class="keywordflow">if</span> (<a class="code" href="classSgAsmBasicString.html#78caa100d3ca1da1ca90edeb3e30bbc0">p_string</a>!=s)
<a name="l00059"></a>00059         <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00060"></a>00060     <a class="code" href="classSgAsmBasicString.html#78caa100d3ca1da1ca90edeb3e30bbc0">p_string</a> = s;
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 <span class="keywordtype">void</span>
<a name="l00063"></a><a class="code" href="classSgAsmBasicString.html#382b18930e31765898e161429aede689">00063</a> <a class="code" href="classSgAsmBasicString.html#6e8c6524a3bae9487e2d19c2155f992a">SgAsmBasicString::set_string</a>(<a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> offset)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     fprintf(stderr, <span class="stringliteral">"SgAsmBasicString::set_string(rose_addr_t offset=%"</span>PRIu64<span class="stringliteral">"): not supported\n"</span>, offset);
<a name="l00066"></a>00066     abort();
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">/* Print some debugging info */</span>
<a name="l00070"></a>00070 <span class="keywordtype">void</span>
<a name="l00071"></a><a class="code" href="classSgAsmBasicString.html#248d5a8cc7593a6fb1cedfa46c0d3226">00071</a> <a class="code" href="classSgAsmBasicString.html#248d5a8cc7593a6fb1cedfa46c0d3226">SgAsmBasicString::dump</a>(FILE *f, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="SgUnaryOp_8docs.html#c6cf1576467b95ef29f025f8e47eea437afa939f8bd773f5f7e326990b07580c">prefix</a>, ssize_t idx)<span class="keyword"> const</span>
<a name="l00072"></a>00072 <span class="keyword"></span>{
<a name="l00073"></a>00073     <span class="keywordtype">char</span> p[4096];
<a name="l00074"></a>00074     <span class="keywordflow">if</span> (idx&gt;=0) {
<a name="l00075"></a>00075         sprintf(p, <span class="stringliteral">"%sBasicString[%zd]."</span>, prefix, idx);
<a name="l00076"></a>00076     } <span class="keywordflow">else</span> {
<a name="l00077"></a>00077         sprintf(p, <span class="stringliteral">"%sBasicString."</span>, prefix);
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079     <span class="keywordtype">int</span> w = std::max(1, <a class="code" href="Cxx__Grammar_8h.html#b09cd568db5adadb46869d1ae0f6db69">DUMP_FIELD_WIDTH</a>-(<span class="keywordtype">int</span>)strlen(p));
<a name="l00080"></a>00080     fprintf(f, <span class="stringliteral">"%s%-*s = \"%s\"\n"</span>, p, w, <span class="stringliteral">"value"</span>, <a class="code" href="classSgAsmBasicString.html#176b4a26f1315f64c7de4b920b88646d">get_string</a>(<span class="keyword">true</span>).c_str());
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082     
<a name="l00083"></a>00083 <span class="comment">/* Stored String constructors/destructor */</span>
<a name="l00084"></a>00084 <span class="keywordtype">void</span>
<a name="l00085"></a><a class="code" href="classSgAsmStoredString.html#00205bbdca6bbfa814196d456c3ef3c0">00085</a> <a class="code" href="classSgAsmStoredString.html#00205bbdca6bbfa814196d456c3ef3c0">SgAsmStoredString::ctor</a>(<a class="code" href="classSgAsmGenericStrtab.html">SgAsmGenericStrtab</a> *strtab, <a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> offset, <span class="keywordtype">bool</span> shared)
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087     <a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a> = strtab-&gt;<a class="code" href="classSgAsmGenericStrtab.html#45c3bc16a91fdf37117ea292cd267db9">create_storage</a>(offset, shared);
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 <span class="keywordtype">void</span>
<a name="l00090"></a><a class="code" href="classSgAsmStoredString.html#85dc89894151ce8ab3d2315833e1c7f2">00090</a> <a class="code" href="classSgAsmStoredString.html#00205bbdca6bbfa814196d456c3ef3c0">SgAsmStoredString::ctor</a>(<a class="code" href="classSgAsmGenericStrtab.html">SgAsmGenericStrtab</a> *strtab, <span class="keyword">const</span> std::string &amp;s)
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092     <a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a> = strtab-&gt;<a class="code" href="classSgAsmGenericStrtab.html#45c3bc16a91fdf37117ea292cd267db9">create_storage</a>(0, <span class="keyword">false</span>);
<a name="l00093"></a>00093     <a class="code" href="classSgAsmStoredString.html#2ba1b5ac080348f33e7748e140ff4c3a">set_string</a>(s);
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 <span class="keywordtype">void</span>
<a name="l00096"></a><a class="code" href="classSgAsmStoredString.html#8465784e64d0c12027ea8518753d00a2">00096</a> <a class="code" href="classSgAsmStoredString.html#00205bbdca6bbfa814196d456c3ef3c0">SgAsmStoredString::ctor</a>(<a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a> = storage;
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 <span class="preprocessor">#if 0</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="comment">// DQ (9/9/2008): Use the destructor built automatically by ROSETTA.</span>
<a name="l00102"></a>00102 <a class="code" href="classSgAsmStoredString.html#236c870b79e30a7bd169aed289665acf">SgAsmStoredString::~SgAsmStoredString</a>()
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104 <span class="preprocessor">#if 0 </span><span class="comment">/* FIXME: Strings may share storage, so we can't free it. (RPM 2008-09-03) */</span>
<a name="l00105"></a>00105     <span class="comment">/* Free storage if it isn't associated with a string table. */</span>
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (<a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a> &amp;&amp; NULL==<a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a>-&gt;strtab)
<a name="l00107"></a>00107         <span class="keyword">delete</span> <a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a>;
<a name="l00108"></a>00108 <span class="preprocessor">#endif</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>    <a class="code" href="classSgAsmStoredString.html#ff3cb2da89d2d92d2ff098c49286b583">p_storage</a> = NULL;
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 <span class="preprocessor">#endif</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>
<a name="l00114"></a>00114 std::string
<a name="l00115"></a><a class="code" href="classSgAsmStoredString.html#f4788d772f987871d9a7245a8f7497e9">00115</a> <a class="code" href="classSgAsmStoredString.html#f4788d772f987871d9a7245a8f7497e9">SgAsmStoredString::get_string</a>(<span class="keywordtype">bool</span> <a class="code" href="namespaceDbg.html#30e026df9550320a5ed77068dc06d501">escape</a>)<span class="keyword"> const </span>
<a name="l00116"></a>00116 <span class="keyword"></span>{
<a name="l00117"></a>00117     std::string retval = <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStringStorage.html#7c64b44f42923f2da49cdb4118a9059e">get_string</a>();
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (escape)
<a name="l00119"></a>00119         retval = <a class="code" href="escape_8h.html#fe2eed2102b5e1df8cf454304111f5ca">escapeString</a>(retval);
<a name="l00120"></a>00120     <span class="keywordflow">return</span> retval;
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00125"></a>00125 <a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a>
<a name="l00126"></a><a class="code" href="classSgAsmStoredString.html#4e1d0286addfe29e1bfc984a676c31e9">00126</a> <a class="code" href="classSgAsmStoredString.html#4e1d0286addfe29e1bfc984a676c31e9">SgAsmStoredString::get_offset</a>()<span class="keyword"> const</span>
<a name="l00127"></a>00127 <span class="keyword"></span>{
<a name="l00128"></a>00128     <span class="keywordflow">if</span> (NULL==<a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>())
<a name="l00129"></a>00129         <span class="keywordflow">return</span> <a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">unallocated</a>;
<a name="l00130"></a>00130     <span class="keywordflow">if</span> (<a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStoredString.html#4e1d0286addfe29e1bfc984a676c31e9">get_offset</a>() == <a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">unallocated</a>) {
<a name="l00131"></a>00131         <a class="code" href="classSgAsmGenericStrtab.html">SgAsmGenericStrtab</a> *strtab = <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStringStorage.html#5149558fca6a53669fdef23219b27d00">get_strtab</a>();
<a name="l00132"></a>00132         ROSE_ASSERT(strtab!=NULL);
<a name="l00133"></a>00133         strtab-&gt;<a class="code" href="classSgAsmGenericStrtab.html#66dc9c834cc645af9487fcfe91eee913">reallocate</a>(<span class="keyword">false</span>);
<a name="l00134"></a>00134         ROSE_ASSERT(<a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStoredString.html#4e1d0286addfe29e1bfc984a676c31e9">get_offset</a>() != <a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">unallocated</a>);
<a name="l00135"></a>00135     }
<a name="l00136"></a>00136     <span class="keywordflow">return</span> <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStringStorage.html#1cff7491a2d5c21589781473c8415d61">get_offset</a>();
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00140"></a>00140 <a class="code" href="classSgAsmGenericStrtab.html">SgAsmGenericStrtab</a> *
<a name="l00141"></a><a class="code" href="classSgAsmStoredString.html#74394a337215bcfec0a4f8cdba23c272">00141</a> <a class="code" href="classSgAsmStoredString.html#74394a337215bcfec0a4f8cdba23c272">SgAsmStoredString::get_strtab</a>() 
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143     <span class="keywordflow">return</span> <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStringStorage.html#5149558fca6a53669fdef23219b27d00">get_strtab</a>();
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00147"></a>00147 <span class="keywordtype">void</span>
<a name="l00148"></a><a class="code" href="classSgAsmStoredString.html#2ba1b5ac080348f33e7748e140ff4c3a">00148</a> <a class="code" href="classSgAsmStoredString.html#2ba1b5ac080348f33e7748e140ff4c3a">SgAsmStoredString::set_string</a>(<span class="keyword">const</span> std::string &amp;s)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (<a class="code" href="classSgAsmStoredString.html#f4788d772f987871d9a7245a8f7497e9">get_string</a>()==s) <span class="keywordflow">return</span>; <span class="comment">/* no change in value */</span>
<a name="l00151"></a>00151     <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00152"></a>00152     <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage = <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>();
<a name="l00153"></a>00153     ROSE_ASSERT(storage!=NULL); <span class="comment">/* we don't even know which string table! */</span>
<a name="l00154"></a>00154     storage-&gt;<a class="code" href="classSgAsmStringStorage.html#5149558fca6a53669fdef23219b27d00">get_strtab</a>()-&gt;<a class="code" href="classSgAsmGenericStrtab.html#0f3b032a7db49b3c4363093f38420711">free</a>(storage);
<a name="l00155"></a>00155     storage-&gt;<a class="code" href="classSgAsmStringStorage.html#1984a0f961ca41cf837c0e29ed9797ab">set_string</a>(s);
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00159"></a>00159 <span class="keywordtype">void</span>
<a name="l00160"></a><a class="code" href="classSgAsmStoredString.html#0104e042ce62ebbe4bfc88157e85c7de">00160</a> <a class="code" href="classSgAsmStoredString.html#2ba1b5ac080348f33e7748e140ff4c3a">SgAsmStoredString::set_string</a>(<a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> offset)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00163"></a>00163     <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage = <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>();
<a name="l00164"></a>00164     ROSE_ASSERT(storage!=NULL); <span class="comment">/* we don't even know which string table! */</span>
<a name="l00165"></a>00165     storage-&gt;<a class="code" href="classSgAsmStringStorage.html#5149558fca6a53669fdef23219b27d00">get_strtab</a>()-&gt;<a class="code" href="classSgAsmGenericStrtab.html#6834b25d1de20deab0d8c299dea6c770">rebind</a>(storage, offset);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="comment">/* Print some debugging info */</span>
<a name="l00169"></a>00169 <span class="keywordtype">void</span>
<a name="l00170"></a><a class="code" href="classSgAsmStoredString.html#8453f054c202584e5de355bd3a6ce30a">00170</a> <a class="code" href="classSgAsmStoredString.html#8453f054c202584e5de355bd3a6ce30a">SgAsmStoredString::dump</a>(FILE *f, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="SgUnaryOp_8docs.html#c6cf1576467b95ef29f025f8e47eea437afa939f8bd773f5f7e326990b07580c">prefix</a>, ssize_t idx)<span class="keyword"> const</span>
<a name="l00171"></a>00171 <span class="keyword"></span>{
<a name="l00172"></a>00172     <span class="keywordtype">char</span> p[4096];
<a name="l00173"></a>00173     <span class="keywordflow">if</span> (idx&gt;=0) {
<a name="l00174"></a>00174         sprintf(p, <span class="stringliteral">"%sStoredString[%zd]."</span>, prefix, idx);
<a name="l00175"></a>00175     } <span class="keywordflow">else</span> {
<a name="l00176"></a>00176         sprintf(p, <span class="stringliteral">"%sStoredString."</span>, prefix);
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     <span class="keywordtype">int</span> w = std::max(1, <a class="code" href="Cxx__Grammar_8h.html#b09cd568db5adadb46869d1ae0f6db69">DUMP_FIELD_WIDTH</a>-(<span class="keywordtype">int</span>)strlen(p));
<a name="l00179"></a>00179     
<a name="l00180"></a>00180     fprintf(f, <span class="stringliteral">"%s%-*s = 0x%08lx\n"</span>, p, w, <span class="stringliteral">"storage"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>());
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (<a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>())
<a name="l00182"></a>00182         <a class="code" href="classSgAsmStoredString.html#cc3546c053bb366030a564a57ea63a56">get_storage</a>()-&gt;<a class="code" href="classSgAsmStringStorage.html#f283b61313e2a9376a8b62bc3f5082bb">dump</a>(f, p, -1);
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">/* Print some debugging info */</span>
<a name="l00186"></a>00186 <span class="keywordtype">void</span>
<a name="l00187"></a><a class="code" href="classSgAsmStringStorage.html#f283b61313e2a9376a8b62bc3f5082bb">00187</a> <a class="code" href="classSgAsmStringStorage.html#f283b61313e2a9376a8b62bc3f5082bb">SgAsmStringStorage::dump</a>(FILE *f, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="SgUnaryOp_8docs.html#c6cf1576467b95ef29f025f8e47eea437afa939f8bd773f5f7e326990b07580c">prefix</a>, ssize_t idx)<span class="keyword"> const</span>
<a name="l00188"></a>00188 <span class="keyword"></span>{
<a name="l00189"></a>00189     <span class="keywordtype">char</span> p[4096];
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (idx&gt;=0) {
<a name="l00191"></a>00191         sprintf(p, <span class="stringliteral">"%sStringStorage[%zd]."</span>, prefix, idx);
<a name="l00192"></a>00192     } <span class="keywordflow">else</span> {
<a name="l00193"></a>00193         sprintf(p, <span class="stringliteral">"%sStringStorage."</span>, prefix);
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195     <span class="keywordtype">int</span> w = std::max(1, <a class="code" href="Cxx__Grammar_8h.html#b09cd568db5adadb46869d1ae0f6db69">DUMP_FIELD_WIDTH</a>-(<span class="keywordtype">int</span>)strlen(p));
<a name="l00196"></a>00196     
<a name="l00197"></a>00197     fprintf(f, <span class="stringliteral">"%s%-*s ="</span>, p, w, <span class="stringliteral">"sec,offset,val"</span>);
<a name="l00198"></a>00198     <a class="code" href="classSgAsmGenericStrtab.html">SgAsmGenericStrtab</a> *strtab = <a class="code" href="classSgAsmStringStorage.html#5149558fca6a53669fdef23219b27d00">get_strtab</a>();
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (strtab) {
<a name="l00200"></a>00200         fprintf(f, <span class="stringliteral">" section [%d] \"%s\""</span>,
<a name="l00201"></a>00201                 strtab-&gt;<a class="code" href="classSgAsmGenericStrtab.html#1037ec4196d200437744d6e4b9904dff">get_container</a>()-&gt;<a class="code" href="classSgAsmGenericSection.html#3affce63e89687a490938dde931e7125">get_id</a>(),
<a name="l00202"></a>00202                 strtab-&gt;<a class="code" href="classSgAsmGenericStrtab.html#1037ec4196d200437744d6e4b9904dff">get_container</a>()-&gt;<a class="code" href="classSgAsmGenericSection.html#51a0421548dbe52e9f2dd06a0ba8d4a9">get_name</a>()-&gt;<a class="code" href="classSgAsmGenericString.html#ba8bc51c8d891e4f8e8e87c45c62f7d5">get_string</a>(<span class="keyword">true</span>).c_str());
<a name="l00203"></a>00203     } <span class="keywordflow">else</span> {
<a name="l00204"></a>00204         fputs(<span class="stringliteral">" no section"</span>, f);
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (!strtab || <a class="code" href="classSgAsmStringStorage.html#1cff7491a2d5c21589781473c8415d61">get_offset</a>()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>) {
<a name="l00207"></a>00207         fputs(<span class="stringliteral">", not allocated"</span>, f);
<a name="l00208"></a>00208     } <span class="keywordflow">else</span> {
<a name="l00209"></a>00209         fprintf(f, <span class="stringliteral">", offset 0x%08"</span>PRIx64<span class="stringliteral">" (%"</span>PRIu64<span class="stringliteral">")"</span>, <a class="code" href="classSgAsmStringStorage.html#1cff7491a2d5c21589781473c8415d61">get_offset</a>(), <a class="code" href="classSgAsmStringStorage.html#1cff7491a2d5c21589781473c8415d61">get_offset</a>());
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     fprintf(f, <span class="stringliteral">", \"%s\"\n"</span>, <a class="code" href="escape_8h.html#fe2eed2102b5e1df8cf454304111f5ca">escapeString</a>(<a class="code" href="classSgAsmStringStorage.html#7c64b44f42923f2da49cdb4118a9059e">get_string</a>()).c_str());
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00215"></a>00215 <a class="code" href="classSgAsmStoredString.html">SgAsmStoredString</a> *
<a name="l00216"></a><a class="code" href="classSgAsmGenericStrtab.html#4ccbf8be1d8607812089bcf5d1592071">00216</a> <a class="code" href="classSgAsmGenericStrtab.html#4ccbf8be1d8607812089bcf5d1592071">SgAsmGenericStrtab::create_string</a>(<a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> offset, <span class="keywordtype">bool</span> shared)
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage = <a class="code" href="classSgAsmGenericStrtab.html#45c3bc16a91fdf37117ea292cd267db9">create_storage</a>(offset, shared);
<a name="l00219"></a>00219     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSgAsmStoredString.html">SgAsmStoredString</a>(storage);
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00224"></a>00224 <span class="keywordtype">void</span>
<a name="l00225"></a><a class="code" href="classSgAsmGenericStrtab.html#0f3b032a7db49b3c4363093f38420711">00225</a> <a class="code" href="classSgAsmGenericStrtab.html#0f3b032a7db49b3c4363093f38420711">SgAsmGenericStrtab::free</a>(<a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     ROSE_ASSERT(storage!=NULL);
<a name="l00228"></a>00228     ROSE_ASSERT(storage!=<a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>);
<a name="l00229"></a>00229     <a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> old_offset = storage-&gt;<a class="code" href="classSgAsmStringStorage.html#1cff7491a2d5c21589781473c8415d61">get_offset</a>();
<a name="l00230"></a>00230     <span class="keywordflow">if</span> (old_offset!=<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>) {
<a name="l00231"></a>00231         <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00232"></a>00232         storage-&gt;<a class="code" href="classSgAsmStringStorage.html#70d9a589ec4b3c0c76350cf075b67207">set_offset</a>(<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>);
<a name="l00233"></a>00233         <a class="code" href="classSgAsmGenericStrtab.html#0f3b032a7db49b3c4363093f38420711">free</a>(old_offset, storage-&gt;<a class="code" href="classSgAsmStringStorage.html#7c64b44f42923f2da49cdb4118a9059e">get_string</a>().size()+1);
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00240"></a>00240 <span class="keywordtype">void</span>
<a name="l00241"></a><a class="code" href="classSgAsmGenericStrtab.html#0f1278c36005484336ce82cd3916a8cb">00241</a> <a class="code" href="classSgAsmGenericStrtab.html#0f3b032a7db49b3c4363093f38420711">SgAsmGenericStrtab::free</a>(<a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> offset, <a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> size)
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243     <span class="keywordflow">if</span> (offset==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a> || 0==size)
<a name="l00244"></a>00244         <span class="keywordflow">return</span>;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     ROSE_ASSERT(offset+size &lt;= <a class="code" href="classSgAsmGenericStrtab.html#1037ec4196d200437744d6e4b9904dff">get_container</a>()-&gt;get_size());
<a name="l00247"></a>00247     <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00248"></a>00248     
<a name="l00249"></a>00249     <span class="comment">/* Make sure area is not already in free list.  The freelist.insert() handles this gracefully, but if we're freeing</span>
<a name="l00250"></a>00250 <span class="comment">     * something that's already in the list then we have a logic error somewhere. */</span>
<a name="l00251"></a>00251     ROSE_ASSERT(!<a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().overlaps(<a class="code" href="Cxx__Grammar_8h.html#d8e49820aaa106bb8a2dc17d9ad38d87">Extent</a>(offset, size)));
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">/* Preserve anything that's still referenced. The caller should have assigned SgAsmStoredString::unalloced to the "offset"</span>
<a name="l00254"></a>00254 <span class="comment">     * member of the string storage to indicate that it's memory in the string table is no longer in use. */</span>
<a name="l00255"></a>00255     <a class="code" href="classExtentMap.html">ExtentMap</a> s_extents;
<a name="l00256"></a>00256     <span class="keywordflow">for</span> (size_t i=0; i&lt;<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size(); i++) {
<a name="l00257"></a>00257         <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage = <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i];
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (storage-&gt;get_offset()!=<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>)
<a name="l00259"></a>00259             s_extents.<a class="code" href="classRangeMap.html#df8ef8a1ea1d08b513487c6043ec0d8d">insert</a>(<a class="code" href="classRange.html">Extent</a>(storage-&gt;get_offset(), <a class="code" href="classSgAsmGenericStrtab.html#81a2f61741523a67e6694764581de024">get_storage_size</a>(storage)));
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261     <a class="code" href="classExtentMap.html">ExtentMap</a> to_free = s_extents.<a class="code" href="classExtentMap.html#416eed6d779f21320a95aad937632ef9">subtract_from</a>(<a class="code" href="Cxx__Grammar_8h.html#d8e49820aaa106bb8a2dc17d9ad38d87">Extent</a>(offset, size));
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="comment">/* Add un-refrened extents to free list. */</span>
<a name="l00264"></a>00264     <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().<a class="code" href="classRangeMap.html#297d504b27078eb077ba93d24f257637">insert_ranges</a>(to_free);
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00270"></a>00270 <span class="keywordtype">void</span>
<a name="l00271"></a><a class="code" href="classSgAsmGenericStrtab.html#d779951ed2296dffed36928ab33445af">00271</a> <a class="code" href="classSgAsmGenericStrtab.html#d779951ed2296dffed36928ab33445af">SgAsmGenericStrtab::free_all_strings</a>(<span class="keywordtype">bool</span> blow_away_holes)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273     <a class="code" href="classSgAsmGenericSection.html">SgAsmGenericSection</a> *container = <a class="code" href="classSgAsmGenericStrtab.html#1037ec4196d200437744d6e4b9904dff">get_container</a>();
<a name="l00274"></a>00274     <a class="code" href="classSgAsmGenericFile.html">SgAsmGenericFile</a> *file = container-&gt;<a class="code" href="classSgAsmGenericSection.html#3fd79ae169d298678808d6a07223de9a">get_file</a>();
<a name="l00275"></a>00275     <span class="keywordtype">bool</span> is_tracking = file-&gt;<a class="code" href="classSgAsmGenericFile.html#840f5e7a6c331a12ec572be161e3fb92">get_tracking_references</a>();
<a name="l00276"></a>00276     <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <span class="comment">/* Mark all storage objects as being unallocated. Never free the dont_free storage (if any). */</span>
<a name="l00279"></a>00279     <span class="keywordflow">for</span> (size_t i=0; i&lt;<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size(); i++) {
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i]-&gt;get_offset()!=<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a> &amp;&amp; <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i]!=<a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>) {
<a name="l00281"></a>00281             <a class="code" href="classSgAsmGenericStrtab.html#43f29a9db72debe7617d7c0f8fdb91d2">p_num_freed</a>++;
<a name="l00282"></a>00282             <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i]-&gt;set_offset(<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>);
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">/* Mark holes as referenced */</span>
<a name="l00287"></a>00287     <span class="keywordflow">if</span> (blow_away_holes) {
<a name="l00288"></a>00288         file-&gt;<a class="code" href="classSgAsmGenericFile.html#726172a6521dd95a9e8f7015eab98d93">set_tracking_references</a>(<span class="keyword">true</span>);
<a name="l00289"></a>00289         file-&gt;<a class="code" href="classSgAsmGenericFile.html#8bd01ea3eed04262984e14d92ac7e2a5">mark_referenced_extent</a>(container-&gt;<a class="code" href="classSgAsmGenericSection.html#c260c8a8e746f7c854fa0b3c82d6d9d9">get_offset</a>(), container-&gt;<a class="code" href="classSgAsmGenericSection.html#4c0fa714119712ac19d50340d62ab8f1">get_size</a>());
<a name="l00290"></a>00290         file-&gt;<a class="code" href="classSgAsmGenericFile.html#726172a6521dd95a9e8f7015eab98d93">set_tracking_references</a>(is_tracking);
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="comment">/* The free list is everything that's been referenced in the container section. */</span>
<a name="l00294"></a>00294     <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>() = container-&gt;<a class="code" href="classSgAsmGenericSection.html#bf29d4fad5dd5f8385b3ab310d505607">get_referenced_extents</a>();
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="comment">/* Remove the empty string from the free list */</span>
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (<a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>)
<a name="l00298"></a>00298         <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().<a class="code" href="classRangeMap.html#a601374137845507fa80c404308ac426">erase</a>(<a class="code" href="Cxx__Grammar_8h.html#d8e49820aaa106bb8a2dc17d9ad38d87">Extent</a>(<a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>-&gt;<a class="code" href="classSgAsmStringStorage.html#1cff7491a2d5c21589781473c8415d61">get_offset</a>(), <a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>-&gt;<a class="code" href="classSgAsmStringStorage.html#7c64b44f42923f2da49cdb4118a9059e">get_string</a>().size()+1));
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 
<a name="l00304"></a>00304 <span class="keywordtype">bool</span>
<a name="l00305"></a><a class="code" href="classSgAsmGenericStrtab.html#66dc9c834cc645af9487fcfe91eee913">00305</a> <a class="code" href="classSgAsmGenericStrtab.html#66dc9c834cc645af9487fcfe91eee913">SgAsmGenericStrtab::reallocate</a>(<span class="keywordtype">bool</span> shrink)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307     <span class="keywordtype">bool</span> reallocated = <span class="keyword">false</span>;
<a name="l00308"></a>00308     <a class="code" href="classSgAsmGenericSection.html">SgAsmGenericSection</a> *container = <a class="code" href="classSgAsmGenericStrtab.html#1037ec4196d200437744d6e4b9904dff">get_container</a>();
<a name="l00309"></a>00309     <a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> extend_size = 0;                                     <span class="comment">/* amount by which to extend string table */</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="comment">/* Get list of strings that need to be allocated and sort by descending size. */</span>
<a name="l00312"></a>00312     std::vector&lt;size_t&gt; map;
<a name="l00313"></a>00313     <span class="keywordflow">for</span> (size_t i=0; i&lt;<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size(); i++) {
<a name="l00314"></a>00314         <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage = <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i];
<a name="l00315"></a>00315         <span class="keywordflow">if</span> (storage-&gt;get_offset()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>) {
<a name="l00316"></a>00316             map.push_back(i);
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319     <span class="keywordflow">for</span> (size_t i=1; i&lt;map.size(); i++) {
<a name="l00320"></a>00320         <span class="keywordflow">for</span> (size_t j=0; j&lt;i; j++) {
<a name="l00321"></a>00321             <span class="keywordflow">if</span> (<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[map[j]]-&gt;get_string().size() &lt; <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[map[i]]-&gt;get_string().size()) {
<a name="l00322"></a>00322                 size_t x = map[i];
<a name="l00323"></a>00323                 map[i] = map[j];
<a name="l00324"></a>00324                 map[j] = x;
<a name="l00325"></a>00325             }
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="comment">/* Allocate from largest to smallest so we have the best chance of finding overlaps */</span>
<a name="l00330"></a>00330     <span class="keywordflow">for</span> (size_t i=0; i&lt;map.size(); i++) {
<a name="l00331"></a>00331         <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *storage = <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[map[i]];
<a name="l00332"></a>00332         ROSE_ASSERT(storage-&gt;get_offset()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="comment">/* We point empty strings at the dont_free storage if possible. */</span>
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (storage-&gt;get_string()==<span class="stringliteral">""</span> &amp;&amp; <a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>) {
<a name="l00336"></a>00336             ROSE_ASSERT(<a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>-&gt;<a class="code" href="classSgAsmStringStorage.html#7c64b44f42923f2da49cdb4118a9059e">get_string</a>()==<span class="stringliteral">""</span>);
<a name="l00337"></a>00337             storage-&gt;set_offset(0);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         <span class="comment">/* If there's already a string with the same value then they can share space in the string table. They're still</span>
<a name="l00341"></a>00341 <span class="comment">         * considered two separate strings, so changing one doesn't affect the other. */</span>
<a name="l00342"></a>00342         <span class="keywordflow">if</span> (storage-&gt;get_offset()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>) {
<a name="l00343"></a>00343             <span class="keywordflow">for</span> (size_t j=0; j&lt;<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size(); j++) {
<a name="l00344"></a>00344                 <a class="code" href="classSgAsmStringStorage.html">SgAsmStringStorage</a> *previous = <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[j];
<a name="l00345"></a>00345                 <span class="keywordflow">if</span> (previous-&gt;get_offset()!=<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a> &amp;&amp; previous-&gt;get_string()==storage-&gt;get_string()) {
<a name="l00346"></a>00346                     storage-&gt;set_offset(previous-&gt;get_offset());
<a name="l00347"></a>00347                     <span class="keywordflow">break</span>;
<a name="l00348"></a>00348                 }
<a name="l00349"></a>00349             }
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">/* Some string tables may be able to overlap strings. For instance, ELF can overlap "domain" and "main" since it</span>
<a name="l00353"></a>00353 <span class="comment">         * encodes strings with NUL termination. */</span>
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (storage-&gt;get_offset()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>)
<a name="l00355"></a>00355             <a class="code" href="classSgAsmGenericStrtab.html#dcd384cfd3c55d4292143e030a3f9b04">allocate_overlap</a>(storage);
<a name="l00356"></a>00356         
<a name="l00357"></a>00357         <span class="comment">/* If we couldn't share another string then try to allocate from free space (avoiding holes) */</span>
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (storage-&gt;get_offset()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>) {
<a name="l00359"></a>00359             <span class="keywordflow">try</span> {
<a name="l00360"></a>00360                 <a class="code" href="classRange.html">Extent</a> e = <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().<a class="code" href="classExtentMap.html#cc056182d4b4302df2d3c3ac3181b5f0">allocate_best_fit</a>(storage-&gt;get_string().size()+1);
<a name="l00361"></a>00361                 <a class="code" href="rosedefs_8h.html#03b4aab6bc70ede394422915678b18df">rose_addr_t</a> new_offset = e.first();
<a name="l00362"></a>00362                 storage-&gt;set_offset(new_offset);
<a name="l00363"></a>00363             } <span class="keywordflow">catch</span>(std::bad_alloc &amp;x) {
<a name="l00364"></a>00364                 <span class="comment">/* nothing large enough on the free list */</span>
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <span class="comment">/* If no free space area large enough then prepare to extend the section. */</span>
<a name="l00369"></a>00369         <span class="keywordflow">if</span> (storage-&gt;get_offset()==<a class="code" href="classSgAsmGenericString.html#8f170b44372ce5149d912e62fd1f7d61">SgAsmGenericString::unallocated</a>) {
<a name="l00370"></a>00370             extend_size += storage-&gt;get_string().size() + 1;
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="comment">/* If we were unable to allocate everything and there's still free space then it may be possible to reallocate all</span>
<a name="l00375"></a>00375 <span class="comment">     * strings in order to repack the table and avoid internal fragmentation. */</span>
<a name="l00376"></a>00376     <span class="comment">//FIXME (RPM 2008-09-25)</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     <span class="comment">/* Change string table size as necessary. */</span>
<a name="l00379"></a>00379     <span class="keywordflow">if</span> (extend_size&gt;0) {
<a name="l00380"></a>00380         <span class="comment">/* The string table isn't large enough, so make it larger by extending the section that contains the table. The</span>
<a name="l00381"></a>00381 <span class="comment">         * containing section's "set_size" method should add the new space to the string table's free list. If our recursion</span>
<a name="l00382"></a>00382 <span class="comment">         * level is more than two calls deep then something went horribly wrong! */</span>
<a name="l00383"></a>00383         <span class="keyword">static</span> <span class="keywordtype">bool</span> recursive=<span class="keyword">false</span>;
<a name="l00384"></a>00384         ROSE_ASSERT(!recursive);
<a name="l00385"></a>00385         recursive = reallocated = <span class="keyword">true</span>;
<a name="l00386"></a>00386         <span class="keywordflow">try</span> {
<a name="l00387"></a>00387             container-&gt;<a class="code" href="classSgAsmGenericSection.html#3fd79ae169d298678808d6a07223de9a">get_file</a>()-&gt;<a class="code" href="classSgAsmGenericFile.html#807d86ce48996ba785b23379551dccfd">shift_extend</a>(container, 0, extend_size);
<a name="l00388"></a>00388             <a class="code" href="classSgAsmGenericStrtab.html#66dc9c834cc645af9487fcfe91eee913">reallocate</a>(<span class="keyword">false</span>);
<a name="l00389"></a>00389             recursive = <span class="keyword">false</span>;
<a name="l00390"></a>00390         } <span class="keywordflow">catch</span> (...) {
<a name="l00391"></a>00391             recursive = <span class="keyword">false</span>;
<a name="l00392"></a>00392             <span class="keywordflow">throw</span>;
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shrink &amp;&amp; <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().size()&gt;0) {
<a name="l00395"></a>00395         <span class="comment">/* See if we can release any address space and shrink the containing section. The containing section's "set_size"</span>
<a name="l00396"></a>00396 <span class="comment">         * method will adjust the free list by removing some bytes from it. */</span>
<a name="l00397"></a>00397         <a class="code" href="classRange.html">Extent</a> hi = <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().<a class="code" href="classRangeMap.html#d3f7082969c7967d38c06b2ba6f19197">rbegin</a>()-&gt;first;
<a name="l00398"></a>00398         <span class="keywordflow">if</span> (hi.<a class="code" href="classRange.html#130cadb6ba89a4777ca44fa1a6489f27">first</a>() + hi.<a class="code" href="classRange.html#d2aea45d89cade181ad89a7b75756bf9">size</a>() == container-&gt;<a class="code" href="classSgAsmGenericSection.html#4c0fa714119712ac19d50340d62ab8f1">get_size</a>())
<a name="l00399"></a>00399             container-&gt;<a class="code" href="classSgAsmGenericSection.html#17bc8bfa80ac58ac6510e80de4af5ee0">set_size</a>(hi.<a class="code" href="classRange.html#130cadb6ba89a4777ca44fa1a6489f27">first</a>());
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="keywordflow">if</span> (reallocated)
<a name="l00403"></a>00403         <a class="code" href="classSgNode.html#67ae02f0cd73cb84cbef103cbb002301">set_isModified</a>(<span class="keyword">true</span>);
<a name="l00404"></a>00404     <span class="keywordflow">return</span> reallocated;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00409"></a>00409 <span class="keyword">const</span> <a class="code" href="classExtentMap.html">ExtentMap</a>&amp;
<a name="l00410"></a><a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">00410</a> <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">SgAsmGenericStrtab::get_freelist</a>()<span class="keyword"> const</span>
<a name="l00411"></a>00411 <span class="keyword"></span>{
<a name="l00412"></a>00412     <span class="keywordflow">return</span> <a class="code" href="classSgAsmGenericStrtab.html#86a970923daa035488c2ae6cd30fcbd5">p_freelist</a>;
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 <a class="code" href="classExtentMap.html">ExtentMap</a>&amp;
<a name="l00415"></a><a class="code" href="classSgAsmGenericStrtab.html#57d79ca6fa4969c5ce39fdfbd6db26be">00415</a> <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">SgAsmGenericStrtab::get_freelist</a>()
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <span class="keywordflow">return</span> <a class="code" href="classSgAsmGenericStrtab.html#86a970923daa035488c2ae6cd30fcbd5">p_freelist</a>;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="comment">/* Print some debugging info */</span>
<a name="l00421"></a>00421 <span class="keywordtype">void</span>
<a name="l00422"></a><a class="code" href="classSgAsmGenericStrtab.html#9357466e2cca93e04c17e71c79090fe6">00422</a> <a class="code" href="classSgAsmGenericStrtab.html#9357466e2cca93e04c17e71c79090fe6">SgAsmGenericStrtab::dump</a>(FILE *f, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="SgUnaryOp_8docs.html#c6cf1576467b95ef29f025f8e47eea437afa939f8bd773f5f7e326990b07580c">prefix</a>, ssize_t idx)<span class="keyword"> const</span>
<a name="l00423"></a>00423 <span class="keyword"></span>{
<a name="l00424"></a>00424     <a class="code" href="classSgAsmGenericSection.html">SgAsmGenericSection</a> *container = <a class="code" href="classSgAsmGenericStrtab.html#1037ec4196d200437744d6e4b9904dff">get_container</a>();
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="keywordtype">char</span> p[4096];
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (idx&gt;=0) {
<a name="l00428"></a>00428         sprintf(p, <span class="stringliteral">"%sStrtab[%zd]."</span>, prefix, idx);
<a name="l00429"></a>00429     } <span class="keywordflow">else</span> {
<a name="l00430"></a>00430         sprintf(p, <span class="stringliteral">"%sStrtab."</span>, prefix);
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432     <span class="keywordtype">int</span> w = std::max(1, <a class="code" href="Cxx__Grammar_8h.html#b09cd568db5adadb46869d1ae0f6db69">DUMP_FIELD_WIDTH</a>-(<span class="keywordtype">int</span>)strlen(p));
<a name="l00433"></a>00433     
<a name="l00434"></a>00434     <span class="keywordflow">if</span> (container) {
<a name="l00435"></a>00435         fprintf(f, <span class="stringliteral">"%s%-*s = [%d] \"%s\"\n"</span>, p, w, <span class="stringliteral">"container"</span>,
<a name="l00436"></a>00436                 container-&gt;<a class="code" href="classSgAsmGenericSection.html#3affce63e89687a490938dde931e7125">get_id</a>(), container-&gt;<a class="code" href="classSgAsmGenericSection.html#51a0421548dbe52e9f2dd06a0ba8d4a9">get_name</a>()-&gt;<a class="code" href="classSgAsmGenericString.html#ba8bc51c8d891e4f8e8e87c45c62f7d5">get_string</a>(<span class="keyword">true</span>).c_str());
<a name="l00437"></a>00437     } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438         fprintf(f, <span class="stringliteral">"%s%-*s = &lt;null&gt;\n"</span>, p, w, <span class="stringliteral">"container"</span>);
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     fprintf(f, <span class="stringliteral">"%s%-*s ="</span>, p, w, <span class="stringliteral">"dont_free"</span>);
<a name="l00442"></a>00442     <span class="keywordflow">for</span> (size_t i=0; i&lt;<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size(); ++i) {
<a name="l00443"></a>00443         <span class="keywordflow">if</span> (<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i] == <a class="code" href="classSgAsmGenericStrtab.html#1fe57aa2e4d37ceaa13b7b03b6894868">p_dont_free</a>)
<a name="l00444"></a>00444             fprintf(f, <span class="stringliteral">" p_storage_list[%zu]"</span>, i);
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446     fputc(<span class="charliteral">'\n'</span>, f);
<a name="l00447"></a>00447     
<a name="l00448"></a>00448     fprintf(f, <span class="stringliteral">"%s%-*s = %zu strings\n"</span>, p, w, <span class="stringliteral">"referenced"</span>, <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size());
<a name="l00449"></a>00449     <span class="keywordflow">for</span> (size_t i=0; i&lt;<a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>.size(); i++) {
<a name="l00450"></a>00450         <a class="code" href="classSgAsmGenericStrtab.html#22eb245397ffa7be84bc7c4857d7b540">p_storage_list</a>[i]-&gt;<a class="code" href="classSgAsmGenericStrtab.html#9357466e2cca93e04c17e71c79090fe6">dump</a>(f, p, i);
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     fprintf(f, <span class="stringliteral">"%s%-*s = %"</span>PRIu64<span class="stringliteral">" free regions\n"</span>, p, w, <span class="stringliteral">"freelist"</span>, <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().size());
<a name="l00454"></a>00454     <a class="code" href="classSgAsmGenericStrtab.html#50994dbb2a373404991ada076d4c4232">get_freelist</a>().<a class="code" href="classExtentMap.html#3c907a1bec63b1ea09dbed1bbd60c090">dump_extents</a>(f, p, <span class="stringliteral">"freelist"</span>);
<a name="l00455"></a>00455 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on 20 Jan 2013 for ROSE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
